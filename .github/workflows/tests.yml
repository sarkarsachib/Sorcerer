name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16-latest
        env:
          POSTGRES_DB: sorcerer_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Python dependencies
        run: |
          cd python
          pip install -r requirements.txt
      - name: Run Rust tests
        run: |
          cd rust
          cargo test --all --verbose
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/sorcerer_test
          REDIS_URL: redis://localhost:6379
      - name: Run Python tests
        run: |
          cd python
          pytest tests/ -v --tb=short
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/sorcerer_test
          REDIS_URL: redis://localhost:6379

  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install Python dependencies
        run: |
          cd python
          pip install -r requirements.txt
      - name: Rust Format Check
        run: |
          cd rust
          cargo fmt -- --check
      - name: Rust Clippy
        run: |
          cd rust
          cargo clippy --all -- -D warnings
      - name: Python Black Check
        run: |
          cd python
          pip install black
          black --check sorcerer/ tests/
      - name: Python isort Check
        run: |
          cd python
          pip install isort
          isort --check-only sorcerer/ tests/
      - name: Python MyPy Check
        run: |
          cd python
          pip install mypy
          mypy sorcerer/ --ignore-missing-imports
